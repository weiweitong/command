
# 1. 扫描总体架构

扫描对外接口有: 
## 1.1. 启动扫描模块

启动扫描线程, 初始化扫描模块和审计模块, 创建后台线程记录状态.

## 1.2. 终止扫描模块

设置扫描结束标志位为真, 停止扫描模块, 实际并非直接停止, 而是调用下面的等待扫描结束操作.

## 1.3. 等待扫描结束操作
等待扫描结束后, 终止线程.

## 1.4. 清空扫描状态
清空文件系统扫描状态到日志文件中.

## 1.5. 存储扫描状态
存储扫描状态至本地数据库中.

## 1.6. 扫描配置
含有如扫描线程数等重要的参数.


# 2. 启动扫描模块

扫描标志位意义如下:
```c++
1 -> 干运行
2 -> 忽略运行池
4 -> 运行一次
8 -> 运行无限制
16 -> 只检查触发器, 不做去除处理
32 -> 扫描后不清除孤儿条目
64 -> 即使没有扫描完成也强制运行策略
```

文件总路径为全局配置中的文件系统路径+相对路径.

而如果路径有效，则马上会初始化审计模块.

随后, 启动一个后台线程, 以默认属性初始化该线程:
- 初始线程数为一无符号长整型数
- 初始线程属性为一个数组和一个长整型数
- 初始结束标志位为否


### 2.1. 审计模块

如果之前配置的预设任务栈数大于0, 则将系统的任务栈数设置为该预设任务栈数.

任务栈结构, 以及初始化结果为:
- 一个线程锁, 初始化为空
- 一个信号量, 初始化为0
- 最大栈深度, 初始化为0
- 有序任务队列, 以栈深度的降序排列, 初始化为空

<!-- 得到文件系统设备id,  -->
初始化线程参数, 动态分配线程表, 创造扫描线程, 线程总数为1.6配置中的线程数


# 3. 终止扫描模块

设置扫描结束标志位为真, 停止扫描模块.

## 3.1. 停止扫描模块

此停止操作并非立即停止操作, 会有延迟, 表现如下:

- 对线程表中的线程,设置强制停止标志位为真. 但不会立即终止线程

- 如果仍有线程在运行,等待线程运行结束

- 将扫描结果更新至数据库后, 再完成停止模块


# 4. 等待扫描结束操作

对线程加锁, 等待线程运行结束后, 释放锁.

# 5. 清空扫描状态

立马扫描Robinhood当前状态, 并将状态传入日志中输出.


## 5.1. Robinhood扫描状态

检索当前和已终止的静态审计中的一些数据, 作为Robinhood当前状态返回给调用方. 

计算出扫描间隔后, 锁住扫描信息的更新, 将以下当前状态记录:
- 最后一次扫描的开始时间
- 最后一次扫描的持续时间
- 最后一次扫描是否结束
- 最后一次扫描的行为
- 扫描间隔
- 当前每毫秒扫描条目数
- 平均每毫秒扫描条目数
- 超时次数

如果扫描的任务数不为零的话, 则还要记录以下状态:
- 正在扫描标志位为真
- 已扫描的条目数
- 扫描开始时间
- 扫描错误数

释放对扫描信息加的锁.

## 5.2. 输出日志
在输出日志中, 如果状态分别满足如下的条件,则会在输出日志中会展示:
- 状态的最末扫描时间如果不为零, 则展示最后一次扫描的持续时间, 和是否扫描结束
- 状态的当前扫描间隔不为零, 则展示输出当前扫描间隔
- 当前扫描仍在运行, 则展示已运行时间, 最后一个行为已持续时间, 扫描条目数和扫描错误总数, 扫描线程数与扫描条目数的千倍比率, 当前每毫秒扫描条目数, 平均每毫秒扫描条目数. 
- 如有扫描超时, 展示超时次数


# 6. 存储扫描状态

调用5.1中的Robinhood扫描状态, 并将扫描状态以类似于5.2中的输出日志的方式,存储到数据库文件中.




# 7. 扫描配置
扫描配置中,可以配置的参数有:
- 扫描线程数
- 最小/最大扫描时间间隔
- 再次扫描延迟时间
- 扫描超时后行为
- 扫描超时是否退出
- 为了开始审计程序,或挂起线程的假脱机间隔
- 预先分配任务量
- 待扫描的文件列表
- 文件总数
- 已完成的命令
- 忽略列表
- 忽略的总数
